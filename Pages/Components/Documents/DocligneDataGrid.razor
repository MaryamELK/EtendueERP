@using EtendueERP.Models.SageAPI
@using Microsoft.EntityFrameworkCore
@using Data
@inject Radzen.DialogService DialogService


<RadzenAccordion>
    <Items>
        <RadzenAccordionItem Expanded="True" Text="Filtrer">
        </RadzenAccordionItem>
    </Items>
</RadzenAccordion>
@if (@items == null)
{

}
else
{
      <RadzenDataGrid RowSelect="@DataGridRowSelect" AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Advanced" AllowSorting="true" AllowPaging="true" PageSize="15" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                Data="@items" TItem="V_DOCLIGNE" LogicalFilterOperator="LogicalFilterOperator.Or" Style="font-size: 9px; font-weight: normal; font-family: Arial; min-height: 150px;" PagerAlwaysVisible="true" AllowColumnPicking="false" AllowColumnReorder="false" Responsive="true">
                    <Columns>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DO_Date" Title="Date" Width="100px" Visible="@DODate"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DO_Piece" Title="Pièce" Width="100px" Visible="@DOPiece"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="AR_Ref" Title="Référence" Width="100px" Visible="@ARRef"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_Design" Title="Designation" Width="100px" Visible="@DLDesign"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_PieceBL" Title="Numéro BL" Width="100px" Visible="@DLPieceBL"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_DateBL" Title="Date BL" Width="100px" Visible="@DLDateBL"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_Qte" Title="Qté" Width="100px" Visible="@DLQte"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_PrixUnitaire" Title="P.U" Width="100px" Visible="@DLPrixUnitaire"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_MontantHT" Title="Montant HT" Width="100px" Visible="@DLMontantHT"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="CT_Intitule" Title="Montant TTC" Width="100px" Visible="@CTIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="CT_Num" Title="N° Tiers" Width="100px" Visible="@CTNum"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="CA_Num" Title="N° Affaire" Width="100px" Visible="@CANum"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="CA_Intitule" Title="Intitulé Affaire" Width="100px" Visible="@CAIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DE_Intitule" Title="Dépot" Width="100px" Visible="@DE_Intitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DomaineIntitule" Title="Donamine" Width="100px" Visible="@DomaineIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_Taxe1" Title="Taux Taxe" Width="100px" Visible="@DLTaxe1"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="DL_CodeTaxe1" Title="Code Taxe" Width="100px" Visible="@DLCodeTaxe1"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="PUTTC" Title="P.U TTC" Width="100px" Visible="@PUTTC"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="MontantTVA" Title="Montant TVA" Width="100px" Visible="@MontantTVA"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="EU_Enemure" Title="Unité" Width="100px" Visible="@EUEnemure"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="PUNet" Title="PU Net" Width="100px" Visible="@PUNet"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="Remise" Title="Remise" Width="100px" Visible="@Remise"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_DOCLIGNE" Property="CO_Nom" Title="Collaborateur" Width="100px" Visible="@CONom"></RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

}



@code
{

    //Parameters
    [Parameter] public ICollection<V_DOCLIGNE> data { get; set; }
    [Parameter] public bool DODate { get; set; } = true;
    [Parameter] public bool DOPiece { get; set; } = true;
    [Parameter] public bool ARRef { get; set; } = true;
    [Parameter] public bool DLDesign { get; set; } = true;
    [Parameter] public bool DLPieceBL { get; set; } = true;
    [Parameter] public bool DLDateBL { get; set; } = true;
    [Parameter] public bool DLQte { get; set; } = true;
    [Parameter] public bool DLPrixUnitaire { get; set; } = true;
    [Parameter] public bool DLMontantHT { get; set; } = true;
    [Parameter] public bool CTIntitule { get; set; } = true;
    [Parameter] public bool CTNum { get; set; } = true;
    [Parameter] public bool CANum { get; set; } = true;
    [Parameter] public bool CAIntitule { get; set; } = true;
    [Parameter] public bool DE_Intitule { get; set; } = true;
    [Parameter] public bool DomaineIntitule { get; set; } = true;
    [Parameter] public bool DLTaxe1 { get; set; } = true;
    [Parameter] public bool DLCodeTaxe1 { get; set; } = true;
    [Parameter] public bool PUTTC { get; set; } = true;
    [Parameter] public bool MontantTVA { get; set; } = true;
    [Parameter] public bool EUEnemure { get; set; } = true;
    [Parameter] public bool PUNet { get; set; } = true;
    [Parameter] public bool Remise { get; set; } = true;
    [Parameter] public bool CONom { get; set; } = true;
    [Parameter] public int DO_Type { get; set; } = -1;
    [Parameter] public int DO_Domaine { get; set; } = -1;
    [Parameter] public int DE_No { get; set; } = -1;
    [Parameter] public int CO_No { get; set; } = -1;
    [Parameter] public string CT_Num { get; set; } = "";
    [Parameter] public string AR_Ref { get; set; } = "";
    [Parameter] public string DO_Piece { get; set; } = "";

    //End Parameters



    SageAPIContext db = new SageAPIContext();
    private ICollection<V_DOCLIGNE> items;

    protected override async Task OnInitializedAsync()
    {
        await Task.Run(LoadData);
    }
    private void LoadData()
    {
        System.Threading.Thread.Sleep(1000);

        if (data == null)
        {
            if(CT_Num != "" || AR_Ref != "" || DE_No != -1 || DO_Type != -1 || DO_Domaine != -1 || CO_No != -1) 
            {

                if(CT_Num != "") 
                {
                    data = db.V_DOCLIGNE.Where(a => a.CT_Num == CT_Num).ToList();
                }
                else if(AR_Ref != "") 
                {
                    data = db.V_DOCLIGNE.Where(a => a.AR_Ref == AR_Ref).ToList();
                }
                else if (DO_Piece != "")
                {
                    data = db.V_DOCLIGNE.Where(a => a.DO_Piece == DO_Piece).ToList();
                }
                else if(DE_No != -1) 
                {
                    data = db.V_DOCLIGNE.Where(a => a.DE_No == DE_No).ToList();
                }
                else if(CO_No != -1) 
                {
                    data = db.V_DOCLIGNE.Where(a => a.CO_No == CO_No).ToList();
                }
                else if(DO_Type != -1) 
                {
                    data = db.V_DOCLIGNE.Where(a => a.DO_Type == DO_Type).ToList();
                }
                else if(DO_Domaine != -1) 
                {
                    data = db.V_DOCLIGNE.Where(a => a.DO_Domaine == DO_Domaine).ToList();
                }

                DataFilter();

            }

            else 
            {
                data = db.V_DOCLIGNE.ToList();
            }

        }
        items = data;
    }



    void OnInput(string value)
    {
        //items = data.ToList();
    }
    protected async Task DataGridRowSelect(V_DOCLIGNE args)
    {

    }

    private void DataFilter()
    {
        if (CT_Num != "")
        {
            data = data.Where(a => a.CT_Num == CT_Num).ToList();
        }
        if (AR_Ref != "" && data != null)
        {
            data = data.Where(a => a.AR_Ref == AR_Ref).ToList();
        }
        if (DE_No != -1 && data != null)
        {
            data = data.Where(a => a.DE_No == DE_No).ToList();
        }
        if (DO_Type != -1 && data != null)
        {
            data = data.Where(a => a.DO_Type == DO_Type).ToList();
        }
        if (DO_Domaine != -1 && data != null)
        {
            data = data.Where(a => a.DO_Domaine == DO_Domaine).ToList();
        }
        if (CO_No != -1 && data != null)
        {
            data = data.Where(a => a.CO_No == CO_No).ToList();
        }
    }




}