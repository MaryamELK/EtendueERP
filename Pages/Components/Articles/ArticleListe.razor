@using EtendueERP.Models.SageAPI
@using Microsoft.EntityFrameworkCore
@using Data
@inject DialogService DialogService
@using AntDesign
<Collapse>
    <Panel Header="Filtrer" Key="1">
         <GridRow>
             <GridCol Xs="24" Md="2" Sm="4" class="ant-form-item-label"><label>Recherche</label></GridCol>
            <GridCol Xs="24" Md="7" Sm="14"><Input Style="Width: 100%;" @oninput="@(args => OnInput(args.Value.ToString()))" @bind-Value="@vl_text" /></GridCol>
            <GridCol Xs="24" Md="2" Sm="4" class="ant-form-item-label"><label>Famille</label></GridCol>
            <GridCol Xs="24" Md="3" Sm="6">
                <Select OnSelectedItemChanged="UpdateGrid" @bind-Value="@vl_famille" DataSource="@familles" TItem="F_FAMILLE" TItemValue="string" ValueName="@nameof(F_FAMILLE.FA_CodeFamille)" LabelName="@nameof(F_FAMILLE.FA_Intitule)" />
             </GridCol>
             <GridCol Xs="24" Md="2" Sm="4" class="ant-form-item-label"><label>Unité</label></GridCol>
             <GridCol Xs="24" Md="3" Sm="6">
                <Select OnSelectedItemChanged="UpdateGrid" @bind-Value="@vl_unite" DataSource="@unites" TItem="P_UNITE" TItemValue="short?" ValueName="@nameof(P_UNITE.cbMarq)" LabelName="@nameof(P_UNITE.U_Intitule)" />
             </GridCol>
            <GridCol Xs="24" Md="2" Sm="4" class="ant-form-item-label"><label>Etat de stock</label></GridCol>
             <GridCol Xs="24" Md="3" Sm="6">
                <Select OnSelectedItemChanged="UpdateGrid" TItem="short?" TItemValue="short?" @bind-Value="@vl_stock">
                    <SelectOptions>
                        <SelectOption TItem="short?" TItemValue="short?" Value="0" Label="   Tout"/>
                        <SelectOption TItem="short?" TItemValue="short?" Value="1" Label="En stock"/>
                        <SelectOption TItem="short?" TItemValue="short?" Value="2" Label="Epuisé" />
                    </SelectOptions>
                </Select>
             </GridCol>
          </GridRow>
    </Panel>
</Collapse>
@if (@items == null)
{
 <div class="spin-center">
    <Spin size="large" />
</div>
}
else
{
    <RadzenDataGrid RowSelect="@DataGridRowSelect" AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Advanced" AllowSorting="true" PageSize="40" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                Data="@items" TItem="V_ARTICLE" LogicalFilterOperator="LogicalFilterOperator.Or" Style="font-size: 9px; font-weight: normal; font-family: Arial; min-height: 300px;" PagerAlwaysVisible="true" AllowColumnReorder="false" Responsive="true"
                AllowColumnPicking="true" PageSizeText="élément par page" PagingSummaryFormat="Page {0}/{1} ({2} élément)" ColumnsShowingText="colonnes">
        <Columns>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AR_Ref" Title="Reference" Width="100px" Visible="@ARRef"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AR_Design" Title="Designation" Width="250px" Visible="@ARDesign"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="U_Intitule" Title="Unite" Width="100px" Visible="@UIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="FA_CodeFamille" Title="Code Famille" Width="100px" Visible="@FACodeFamille"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="FA_Intitule" Title="Famille" Width="150px" Visible="@FAIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="SuiviStockIntitule" Title="Suivi Stock" Width="100px" Visible="@SuiviStockIntitule"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AR_PrixAch" Title="Prix Achat" Width="100px" Visible="@ARPrixAch" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AR_PrixVen" Title="Prix Vente" Width="100px" Visible="@ARPrixVen" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="SommeilIntitule" Title="Sommeil" Width="100px" Visible="@SommeilIntitule"></RadzenDataGridColumn>
            <!--Stock-->
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="EtatStock" Title="Etat Stock" Width="100px" Visible="@EtatStock">
                <Template Context="data">
                    @if (data.EtatStock == "Stock �puis�")
                    {
                        <span style='color: #df1111'>@data.EtatStock</span>
                    }
                    else if (data.EtatStock == "En stock")
                    {
                        <span style='color: #089f52'>@data.EtatStock</span>
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AS_QteSto" Title="Qte Stock" Width="100px" Visible="@ASQteSto" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="AS_MontSto" Title="Montant Stock" Width="100px" Visible="@ASMontSto" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right">
                <FooterTemplate>
                    <b>@String.Format(new System.Globalization.CultureInfo("en-US"), "{0:N2}", items.Sum(a => a.AS_MontSto))</b>
                </FooterTemplate>
            </RadzenDataGridColumn>
            <!--Achats-->
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Qte_Achat" Title="Qte Achetee Totale" Width="100px" Visible="@DLQteAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_MontantHT_Achat" Title="Achats HT" Width="100px" Visible="@DLMontantHTAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right">
                <FooterTemplate>
                    <b>@String.Format(new System.Globalization.CultureInfo("en-US"), "{0:N2}", items.Sum(a => a.DL_MontantHT_Achat))</b>
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_MontantTTC_Achat" Title="Achats TTC" Width="100px" Visible="@DLMontantTTCAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right">
                                <FooterTemplate>
                    <b>@String.Format(new System.Globalization.CultureInfo("en-US"), "{0:N2}", items.Sum(a => a.DL_MontantTTC_Achat))</b>
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_DateBL_Achat" Title="Der. Date Achat" Width="100px" Visible="@DLDateBLAchat" FormatString="{0:d}"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_Qte_Achat" Title="Der. Qte Achetee" Width="100px" Visible="@DLDernierQteAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_PU_Achat" Title="Der. PU Achat" Width="100px" Visible="@DLPUAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_MontantHT_Achat" Title="Der. Achat HT" Width="100px" Visible="@DLDernierMontantHTAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_MontantTTC_Achat" Width="100px" Title="Der. Achat TTC" Visible="@DLDernierMontantTTCAchat" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="FR_Intitule" Title="Der. Fournisseur" Width="200px" Visible="@FRIntitule"></RadzenDataGridColumn>
            <!--Ventes-->
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Qte_Vente" Title="Qte Vendues Totale" Width="100px" Visible="@DLQteVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_MontantHT_Vente" Title="CA HT" Width="100px" Visible="@DLMontantHTVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right">
                <FooterTemplate>
                    <b>@String.Format(new System.Globalization.CultureInfo("en-US"), "{0:N2}", items.Sum(a => a.DL_MontantHT_Vente))</b>
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_MontantTTC_Vente" Title="CA TTC" Width="100px" Visible="@DLMontantTTCVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right">
                <FooterTemplate>
                    <b>@String.Format(new System.Globalization.CultureInfo("en-US"), "{0:N2}", items.Sum(a => a.DL_MontantTTC_Vente))</b>
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_DateBL_Vente" Title="Der. Date Vente" Width="100px" Visible="@DLDateBLVente" FormatString="{0:d}"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_Qte_Vente" Title="Der. Qte Venduee" Width="100px" Visible="@DLDernierQteVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_PU_Vente" Title="Der. PU Vente" Width="100px" Visible="@DLPUVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_MontantHT_Vente" Title="Der. Vente HT" Width="100px" Visible="@DLDernierMontantHTVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="DL_Dernier_MontantTTC_Vente" Width="100px" Title="Der. Vente TTC" Visible="@DLDernierMontantTTCVente" FormatString="{0:N2}" TextAlign="Radzen.TextAlign.Right"></RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="V_ARTICLE" Property="CL_Intitule" Title="Der. Client" Width="200px" Visible="@CLIntitule"></RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

}

@code
{

    //Parameters
    [Parameter] public ICollection<V_ARTICLE> data { get; set; }
    [Parameter] public bool ARRef { get; set; } = true;
    [Parameter] public bool ARDesign { get; set; } = true;
    [Parameter] public bool FAIntitule { get; set; } = true;
    [Parameter] public bool FACodeFamille { get; set; } = true;
    [Parameter] public bool ARPrixAch { get; set; } = true;
    [Parameter] public bool ARPrixVen { get; set; } = true;
    [Parameter] public bool UIntitule { get; set; } = true;
    [Parameter] public bool DLQteVente { get; set; } = false;
    [Parameter] public bool DLMontantHTVente { get; set; } = false;
    [Parameter] public bool DLMontantTTCVente { get; set; } = false;
    [Parameter] public bool DLQteAchat { get; set; } = false;
    [Parameter] public bool DLMontantHTAchat { get; set; } = false;
    [Parameter] public bool DLMontantTTCAchat { get; set; } = false;
    [Parameter] public bool CLIntitule { get; set; } = false;
    [Parameter] public bool CLNum { get; set; } = false;
    [Parameter] public bool DLDateBLVente { get; set; } = false;
    [Parameter] public bool DLDernierMontantHTVente { get; set; } = false;
    [Parameter] public bool DLDernierMontantTTCVente { get; set; } = false;
    [Parameter] public bool DLPUVente { get; set; } = false;
    [Parameter] public bool DLDernierQteVente { get; set; } = false;
    [Parameter] public bool FRIntitule { get; set; } = false;
    [Parameter] public bool FRNum { get; set; } = false;
    [Parameter] public bool DLDateBLAchat { get; set; } = false;
    [Parameter] public bool DLDernierMontantHTAchat { get; set; } = false;
    [Parameter] public bool DLDernierMontantTTCAchat { get; set; } = false;
    [Parameter] public bool DLPUAchat { get; set; } = false;
    [Parameter] public bool DLDernierQteAchat { get; set; } = false;
    [Parameter] public bool SuiviStockIntitule { get; set; } = true;
    [Parameter] public bool SommeilIntitule { get; set; } = true;
    [Parameter] public bool ASQteSto { get; set; } = true;
    [Parameter] public bool ASMontSto { get; set; } = true;
    [Parameter] public bool EtatStock { get; set; } = true;
    //End Parameters



    SageAPIContext db = new SageAPIContext();
    string vl_text;
    short? vl_unite = 0;
    short? vl_stock = 0;
    private ICollection<V_ARTICLE> items;
    string vl_famille = "";
    ICollection<P_UNITE> unites;
    ICollection<F_FAMILLE> familles;


    protected override async Task OnInitializedAsync()
    {
        await Task.Run(LoadData);
    }
    private void LoadData()
    {
        System.Threading.Thread.Sleep(3000);
        if (data == null)
        {
            data = db.V_ARTICLE.ToList();
        }
        items = data;

        var un = new P_UNITE();
        un.cbIndice = 0;
        un.U_Intitule = "   Tout";
        unites = db.P_UNITE.Where(a => (a.U_Intitule ?? "") != "").ToList();
        unites.Add(un);
        unites = unites.OrderBy(a => a.U_Intitule).ToList();

        var fa = new F_FAMILLE();
        fa.FA_CodeFamille = "";
        fa.FA_Intitule = "   Tout";
        familles = db.F_FAMILLE.ToList();
        familles.Add(fa);
        familles = familles.OrderBy(a => a.FA_Intitule).ToList();
    }

    protected async Task DataGridRowSelect(V_ARTICLE args)
    {
        await DialogService.OpenAsync<ArticleFiche>($"{args.AR_Design}",
      new Dictionary<string, object>() { { "row", args } },
      new Radzen.DialogOptions() { Width = "1024px", Height = "600px", Resizable = true });
    }
    void OnInput(string value)
    {
        items = items.Where(a => a.AR_Design.ToUpper().Contains(value.ToUpper()) || a.AR_Ref.ToUpper().Contains(value.ToUpper())).ToList();
    }
    void UpdateGrid() {
        items = data;
        if((vl_text??"") != "") {
            items = items.Where(a => a.AR_Design.ToUpper().Contains(((vl_text ?? "")).ToUpper()) || a.AR_Ref.ToUpper().Contains(((vl_text ?? "")).ToUpper())).ToList();
        }
        if(vl_unite != 0) {
            items = items.Where(a => a.AR_UniteVen == vl_unite).ToList();
        }
        if(vl_famille != "") {
            items = items.Where(a => a.FA_CodeFamille == vl_famille).ToList();
        }
        if(vl_stock == 1) {
            items = items.Where(a => a.EtatStock == "En stock").ToList();
        }
        else if(vl_stock == 2) {
            items = items.Where(a => a.EtatStock == "Stock épuisé").ToList();
        }
    }



}