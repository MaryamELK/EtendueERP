@using EtendueERP.Models.SageAPI
@using Microsoft.EntityFrameworkCore
@using Data
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using EtendueERP.Pages.Components.Documents
@using EtendueERP.Pages.Components.Articles
@using AntDesign

<div>
    <GridRow>
        <GridCol Xs="24" Md="24">
            <RadzenButton>Enregistrer</RadzenButton>
            <RadzenButton>Annuler</RadzenButton>
        </GridCol>
    </GridRow>
    <GridRow>
        <GridCol Xs="24" Md="24">
            <Form Model="@row" Size="@AntSizeLDSType.Small" Layout="@FormLayout.Horizontal" LabelColSpan="6">
                <Tabs DefaultActiveKey="1">
                    <TabPane Key="1" Tab="Indentification">
                        <GridRow>
                                <GridCol Xs="24" Md="24">
                                        <FormItem Label="Designation" LabelColSpan="3">
                                            <Input @bind-Value="@row.AR_Design" />
                                        </FormItem>
                                    </GridCol>
                                    <GridCol Xs="24" Md="12">
                                        <FormItem Label="Reference">
                                            <Input @bind-Value="@row.AR_Ref" />
                                        </FormItem>
                                        <FormItem Label="Code barre">
                                            <Input @bind-Value="@row.AR_Ref" />
                                        </FormItem>
                                        <FormItem Label="Famille">
                                            <Select DataSource="@familles" TItem="F_FAMILLE" TItemValue="string" ValueName="@nameof(F_FAMILLE.FA_CodeFamille)" LabelName="@nameof(F_FAMILLE.FA_Intitule)" @bind-Value="@row.FA_CodeFamille" />
                                        </FormItem>
                                        <FormItem Label="Unite">
                                            <Select DataSource="@unites" TItem="P_UNITE" TItemValue="short?" ValueName="@nameof(P_UNITE.cbMarq)" LabelName="@nameof(P_UNITE.U_Intitule)" @bind-Value="@row.AR_UniteVen" />
                                        </FormItem>
                                    </GridCol>
                                    <GridCol Xs="24" Md="12">
                                        <FormItem Label="Suivi de stock">
                                    <Select TItem="short?" TItemValue="short?" @bind-Value="@row.AR_SuiviStock">
                                                <SelectOptions>
                                            <SelectOption TItem="short?" TItemValue="short?" Value="0" Label="Aucun" />
                                                    <SelectOption TItem="short?" TItemValue="short?" Value="1" Label="Serie" />
                                                    <SelectOption TItem="short?" TItemValue="short?" Value="2" Label="CMUP" />
                                                    <SelectOption TItem="short?" TItemValue="short?" Value="3" Label="FIFO" />
                                                    <SelectOption TItem="short?" TItemValue="short?" Value="4" Label="LIFO" />
                                            <SelectOption TItem="short?" TItemValue="short?" Value="5" Label="Lot" />
                                                </SelectOptions>
                                            </Select>
                                        </FormItem>
                                        <FormItem Label="Prix d'achat'">
                                            <AntDesign.InputNumber @bind-Value="@row.AR_PrixAch" />
                                        </FormItem>
                                        <FormItem Label="Prix de vente'">
                                            <AntDesign.InputNumber @bind-Value="@row.AR_PrixVen" />
                                        </FormItem>
                                    </GridCol>
                            </GridRow>
                    </TabPane>
                    <TabPane Key="3" Tab="Stock">
                        <GridRow>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Etat de stock" Value="@((row.EtatStock ?? ""))" ValueStyle="color: #3f8600;"/>
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Quantitee de stock" Value="@((row.AS_QteSto ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="@row.U_Intitule" />
                            </GridCol>
                             <GridCol Xs="24" Md="8">
                                <Statistic Title="Montant du stock" Value="@((row.AS_MontSto ?? 0).ToString ("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="DH" />
                            </GridCol>

                            <GridCol Xs="24" Md="24">
                                <DocligneDataGrid AR_Ref="@row.AR_Ref" Page="14" IsStock="true" Remise="false" DLPrixUnitaire="false" DEIntitule="false" ARRef="false"
                                DLDesign="false" DLCodeTaxe1="false" DLTaxe1="false" MontantTVA="false" DLMontantTTC="false" TypeIntitule="true"
                                QteMvt="true" DLDateBL="false" DLQte="false"
                                />
                            </GridCol>
                        </GridRow>
                    </TabPane>
                    <TabPane Key="4" Tab="Achats">
                        <GridRow>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Total quantitée achetée" Value="@((row.DL_Qte_Achat ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="@row.U_Intitule"/>
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="CA Achats HT" Value="@((row.DL_MontantHT_Achat ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="DH" />
                            </GridCol>
                             <GridCol Xs="24" Md="8">
                                <Statistic Title="CA Achats TTC" Value="@((row.DL_MontantTTC_Achat ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="DH" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Dernier prix d'achat" Value="@((row.DL_PU_Achat ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Dernier quantitee achetee" Value="@((row.DL_Dernier_Qte_Achat ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Fourisseur" Value="@(row.FR_Intitule??"")" ValueStyle="color: #3f8600;" />
                            </GridCol>


                            <GridCol Xs="24" Md="24">
                                <DocligneDataGrid AR_Ref="@row.AR_Ref" DO_Domaine=1 Page="14"
                                                  DEIntitule="false" ARRef="false"
                                                  DLDesign="false" DLTaxe1="false" TypeIntitule="true"
                                                  DLDateBL="false" />
                            </GridCol>
                        </GridRow>
                    </TabPane>
                    <TabPane Key="5" Tab="Ventes">
                        <GridRow>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Total quantitée vendue" Value="@((row.DL_Qte_Vente ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="@row.U_Intitule"/>
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="CA Ventes HT" Value="@((row.DL_MontantHT_Vente ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="DH" />
                            </GridCol>
                             <GridCol Xs="24" Md="8">
                                <Statistic Title="CA Ventes TTC" Value="@((row.DL_MontantTTC_Vente ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" Suffix="DH" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Dernier prix de vente" Value="@((row.DL_PU_Vente ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Dernier quantitee vendue" Value="@((row.DL_Dernier_Qte_Vente ?? 0).ToString("### ### ### ##0.00"))" Precision="2" ValueStyle="color: #3f8600;" />
                            </GridCol>
                            <GridCol Xs="24" Md="8">
                                <Statistic Title="Client" Value="@(row.CL_Intitule??"")" ValueStyle="color: #3f8600;" />
                            </GridCol>


                            <GridCol Xs="24" Md="24">
                                <DocligneDataGrid AR_Ref="@row.AR_Ref" DO_Domaine=0 Page="14"
                                                  DEIntitule="false" ARRef="false"
                                                  DLDesign="false" DLTaxe1="false" TypeIntitule="true"
                                                  DLDateBL="false" />
                            </GridCol>
                        </GridRow>
                    </TabPane>
                </Tabs>
            </Form>
            
        </GridCol>

    </GridRow>
</div>



@code {
	    [Parameter] public V_ARTICLE row { get; set; }

    SageAPIContext db = new SageAPIContext();
    ICollection<P_UNITE> unites;
    ICollection<SuiviStock> suivistock;
    ICollection<F_FAMILLE> familles;
    ICollection<F_DOCLIGNE> achats;
    ICollection<F_DOCLIGNE> ventes;

    private class SuiviStock
    {
        public int suivi { get; set; }
        public string intitule { get; set; }
    }

    private void LoadData()
    {
        unites = db.P_UNITE.Where(a => (a.U_Intitule??"") != "").ToList();
        familles = db.F_FAMILLE.ToList();
    }
    private void LoadAchats()
    {
        achats = db.F_DOCLIGNE.Where(a => a.AR_Ref == row.AR_Ref && a.DO_Domaine == 1).ToList();
    }


    protected override void OnInitialized()
    {
        LoadData();
    }
}